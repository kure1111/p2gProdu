<template>
    
    <lightning-modal-body>
        <div>

            <template if:true={isLoading}>
                <!-- Muestra el spinner mientras isLoading es verdadero -->
                <lightning-spinner alternative-text="Loading" size="small"></lightning-spinner>
            </template>
            
            <template if:true={showWarning}>
                <div class={warningClass}>
                    <div class="slds-notify_container slds-is-absolute">
                        <div class="slds-notify slds-notify_toast slds-theme_warning" role="status">
                            <span class="slds-assistive-text">warning</span>
                            <span class="slds-icon_container slds-icon-utility-warning slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                <lightning-icon icon-name="utility:warning" size="small"></lightning-icon>
                            </span>
                            <div class="slds-notify__content">
                                <h2 class="slds-text-heading_small">{warningMessage}</h2>
                            </div>
                            <div class="slds-notify__close">
                                <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick={closeMessage}>
                                    <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                                    <span class="slds-assistive-text">Close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <template if:true={showSuccess}>
                <div class={successClass}>
                    <div class="slds-notify_container slds-is-absolute">
                        <div class="slds-notify slds-notify_toast slds-theme_success" role="status">
                            <span class="slds-assistive-text">success</span>
                            <span class="slds-icon_container slds-icon-utility-success slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                <lightning-icon icon-name="utility:success" size="small"></lightning-icon>
                            </span>
                            <div class="slds-notify__content">
                                <h2 class="slds-text-heading_small">{successMessage}</h2>
                            </div>
                            <div class="slds-notify__close">
                                <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick={closeMessage}>
                                    <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                                    <span class="slds-assistive-text">Close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <template if:true={showError}>
                <div class={errorClass}>
                    <div class="slds-notify_container slds-is-absolute">
                        <div class="slds-notify slds-notify_toast slds-theme_error" role="status">
                            <span class="slds-assistive-text">error</span>
                            <span class="slds-icon_container slds-icon-utility-error slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                <lightning-icon icon-name="utility:error" size="small"></lightning-icon>
                            </span>
                            <div class="slds-notify__content">
                                <h2 class="slds-text-heading_small">{errorMessage}</h2>
                            </div>
                            <div class="slds-notify__close">
                                <button class="slds-button slds-button_icon slds-button_icon-inverse" title="Close" onclick={closeMessage}>
                                    <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                                    <span class="slds-assistive-text">Close</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Sección 1 -->
            <div class="slds-card section-card scrollable-section">
                <div class="slds-card__header slds-grid slds-has-flexi-truncate">
                    <h2 class="slds-text-heading_small">Productos: </h2>
                </div>
                <div class="slds-card__body">
                    <!-- Tabla para mostrar OpportunityLineItems -->
                    <div class="horizontal-scroll-container">
                        <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                            <thead>
                                <tr class="slds-line-height_reset">
                                    <th scope="col">
                                        <div class="slds-truncate" title="Cantidad">Cantidad</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Cantidad">Ruta</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Peso de Carga">Peso de Carga</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Unidades por Frecuencia">Unidades por Frecuencia</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Tipo de Mercancía">Tipo de Mercancía</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Frecuencia">Frecuencia</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Tiempo de Carga">Tiempo de Carga</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Tiempo de Descarga">Tiempo de Descarga</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Modalidad">Modalidad</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Dirección de Carga">Dirección de Carga</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Dirección de Descarga">Dirección de Descarga</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="Total Price">Buy Price</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="comentarios">Comentarios</div>
                                    </th>
                                    <th scope="col">
                                        <div class="slds-truncate" title="comentarios">A modificar</div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={opportunityLineItems} for:item="oli">
                                    <tr class="slds-hint-parent" key={oli.IdOli} data-id={oli.IdOli}>
                                        <td>
                                            <lightning-input type="text" value={oli.cantidad} name="cantidad" onchange={handleInputChange}></lightning-input>
                                        </td>

                                        <td>
                                            <div>{oli.Name}</div>
                                        </td>

                                        <td>
                                            <lightning-input type="text" value={oli.pesoDeCarga} name="pesoDeCarga" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.unidadPorFrecuencia} name="unidadPorFrecuencia" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <div style="width: 100%;">
                                                <div onkeyup={searchKeyMercancia2}>
                                                    <lightning-input placeholder="Buscar Mercancia" 
                                                        value={oli.tipoMercancia} type="text"></lightning-input>
                                                </div>
                                                <table if:true={oli.showFila} class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                                    <thead>
                                                        <tr class="slds-line-height_reset">
                                                            <th scope="col">
                                                                <div class="slds-truncate" title="Name">Name</div>
                                                            </th>
                                                            <th scope="col">
                                                                <div class="slds-truncate" title="Clave">Clave</div>
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <template for:each={listMercancia2} for:item="itemMer">
                                                            <tr class="slds-hint-parent" data-id={itemMer.Id} data-name={itemMer.Name} key={itemMer.Id} onclick={mercanciaSelect2}> 
                                                                <td>
                                                                    <div class="slds-truncate">{itemMer.Name}</div>
                                                                </td>
                                                                <template lwc:if={itemMer.Clave_SAT__c}>
                                                                    <td>
                                                                        <div class="slds-truncate">{itemMer.Clave_SAT__c}</div>
                                                                    </td>
                                                                </template>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                        <td>
                                            <lightning-combobox
                                            name="frecuencia"
                                            value={oli.frecuencia}
                                            options={frecuenciaOptions}
                                            onchange={handleInputChange}>
                                            </lightning-combobox>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.tiempoCarga} name="tiempoCarga" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.tiempoDescarga} name="tiempoDescarga" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <div class="slds-truncate">{oli.modalidad}</div>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.direccionCarga} name="direccionCarga" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.direccionDescarga} name="direccionDescarga" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.buyPrice} name="buyPrice" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="text" value={oli.comentarios} name="comentarios" onchange={handleInputChange}></lightning-input>
                                        </td>
                                        <td>
                                            <lightning-input type="checkbox" checked={oli.modificar} name = "modificar" onchange={handleCheck}></lightning-input>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="slds-m-top_medium slds-text-align_right">
                <lightning-button variant="outline-brand" label="Actualizar" onclick={updateItems}></lightning-button>
            </div>
    
            <!-- Sección 2 -->
            <div class="slds-card section-card">
                <div class="slds-card__body">
                    <!-- Contenido de la segunda sección -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
    
                        <div style="width: 100%;">
                            <div onkeyup={searchKeyOrigen}>
                                <lightning-input label="Origen" id="Origen" placeholder="Buscar Origen" 
                                    value={searchOrigen} type="text" required></lightning-input>
                            </div>
                            <table if:true={showOrigen} class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                <thead>
                                   <tr class="slds-line-height_reset">
                                      <th scope="col">
                                         <div class="slds-truncate" title="First Name">Name</div>
                                      </th>
                                      <th scope="col">
                                         <div class="slds-truncate" title="Last Name">Country</div>
                                      </th>
                                      <th scope="col">
                                         <div class="slds-truncate" title="Last Name">State</div>
                                      </th>
                                   </tr>
                                </thead>
                                <tbody>
                                   <template for:each={listOrige} for:item="itemOrigen">
                                      <tr class="slds-hint-parent" data-id={itemOrigen.Id} data-name={itemOrigen.Name} key={itemOrigen.Id} onclick={origenSelect}> 
                                         <td>
                                            <div class="slds-truncate">{itemOrigen.Name}</div>
                                         </td>
                                         <template lwc:if={itemOrigen.Country__c}>
                                            <td>
                                                <div class="slds-truncate">{itemOrigen.Country__r.Name}</div>
                                            </td>
                                        </template>
                                        <template lwc:if={itemOrigen.State__c}>
                                            <td>
                                                <div class="slds-truncate">{itemOrigen.State__r.Name}</div>
                                            </td>
                                        </template>
                                      </tr>
                                   </template>
                                </tbody>
                              </table>
                        </div>
    
                        <!-- Búsqueda de Destino -->
                        <div style="width: 100%;">
                            <div onkeyup={searchKeyDestino}>
                                <lightning-input required label="Destino" id="Destino" placeholder="Buscar Destino" 
                                    value={searchDestino} type="text"></lightning-input>
                            </div>
                            <table if:true={showDestino} class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                <thead>
                                    <tr class="slds-line-height_reset">
                                        <th class="" scope="col">
                                            <div class="slds-truncate" title="First Name">Name</div>
                                        </th>
                                        <th class="" scope="col">
                                            <div class="slds-truncate" title="Last Name">Country</div>
                                        </th>
                                        <th class="" scope="col">
                                            <div class="slds-truncate" title="Last Name">State</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={listDestino} for:item="itemDestino">
                                        <tr class="slds-hint-parent" data-id={itemDestino.Id} data-name={itemDestino.Name} key={itemDestino.Id} onclick={destinoSelect}> 
                                            <td>
                                                <div class="slds-truncate">{itemDestino.Name}</div>
                                            </td>
                                            <template lwc:if={itemDestino.Country__c}>
                                                <td>
                                                    <div class="slds-truncate">{itemDestino.Country__r.Name}</div>
                                                </td>
                                            </template>
                                            <template lwc:if={itemDestino.State__c}>
                                                <td>
                                                    <div class="slds-truncate">{itemDestino.State__r.Name}</div>
                                                </td>
                                            </template>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
    
                        <div style="width: 100%;">
                            <div style="width: 100%;">
                                <lightning-combobox
                                    label="Frecuencia"
                                    value={selectedFrecuencia}
                                    options={frecuenciaOptions}
                                    onchange={handleFrecuenciaChange}>
                                </lightning-combobox>
                            </div>
                        </div>
    
                        <div style="width: 100%;">
                            <div onkeyup={searchKeyModalidad}>
                                <lightning-input required label="Modalidad" id="Modalidad" placeholder="Buscar Modalidad" 
                                    value={searchModalidad} type="text"></lightning-input>
                            </div>
                            <table if:true={showModalidad} class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                        <th class="" scope="col">
                                            <div class="slds-truncate">Container Type</div>
                                        </th>
                                        <th class="" scope="col">
                                            <div class="slds-truncate">Cargo Weight (Kg)</div>
                                        </th>
                                        <th class="" scope="col">
                                            <div class="slds-truncate">Cargo Volume (m3)</div>
                                        </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={listModalidad} for:item="itemModalidad">
                                            <tr class="slds-hint-parent" data-id={itemModalidad.Id} data-name={itemModalidad.Name} key={itemModalidad.Id} onclick={selectModalidad}>
                                                <td>
                                                  <div class="slds-truncate">{itemModalidad.Name}</div>
                                                </td>
                                                <td>
                                                  <div class="slds-truncate">{itemModalidad.Cargo_Weight_Kg__c}</div>
                                                </td>
                                                <td>
                                                  <div class="slds-truncate">{itemModalidad.Cargo_Volume_m3__c}</div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                            </table>
                        </div>
    
                        <div style="width: 100%;">
                            <lightning-input required label="Unidad Por Frecuencia" value={unitPerFrequency} data-fieldname="unitPerFrequency" onchange={handleChange}></lightning-input>
                        </div>
    
                        <div style="width: 100%;">
                            <div onkeyup={searchKeyMercancia}>
                                <lightning-input required label="Mercancia" placeholder="Buscar Mercancia" 
                                    value={searchMercancia} type="text"></lightning-input>
                            </div>
                            <table if:true={showMercancia} class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                <thead>
                                    <tr class="slds-line-height_reset">
                                        <th scope="col">
                                            <div class="slds-truncate" title="Name">Name</div>
                                        </th>
                                        <th scope="col">
                                            <div class="slds-truncate" title="Clave">Clave</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={listMercancia} for:item="itemMer">
                                        <tr class="slds-hint-parent" data-id={itemMer.Id} data-name={itemMer.Name} key={itemMer.Id} onclick={mercanciaSelect}> 
                                            <td>
                                                <div class="slds-truncate">{itemMer.Name}</div>
                                            </td>
                                            <template lwc:if={itemMer.Clave_SAT__c}>
                                                <td>
                                                    <div class="slds-truncate">{itemMer.Clave_SAT__c}</div>
                                                </td>
                                            </template>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
    
                        <div style="width: 100%;">
                            <lightning-input required label="Peso" value={weight} data-fieldname="weight" onchange={handleChange} pattern="^\d*\.?\d*$" ></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input required label="Dirección de Carga" value={loadingAddress} data-fieldname="loadingAddress" onchange={handleChange}></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input required label="Dirección de Descarga" value={unloadingAddress} data-fieldname="unloadingAddress" onchange={handleChange}></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input required label="Cantidad" value={quantity} data-fieldname="quantity" onchange={handleChange}></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input required label="Tiempo Carga" value={timeLoad} data-fieldname="timeLoad" onchange={handleChange} pattern="\d*" title="Ingresa un número entero"></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input required label="Tiempo Descarga" value={timeUnload} data-fieldname="timeUnload" onchange={handleChange} pattern="\d*" title="Ingresa un número entero"></lightning-input>
                        </div>

                        <div style="width: 100%;">
                            <div style="width: 100%;">
                                <lightning-combobox required
                                    label="Tipo de Moneda"
                                    value={selectedMoneda}
                                    options={monedaOptions}
                                    onchange={handleMonedaChange}>
                                </lightning-combobox>
                            </div>
                        </div>

                        <div style="width: 100%;">
                            <lightning-input label="Comentarios: " value={comentarios} data-fieldname="comentarios" onchange={handleChange}></lightning-input>
                        </div>

                        <div style="width: 100%;">
                        </div>
                    </div>
                </div>
                <div class="slds-m-top_medium slds-text-align_right">
                    <lightning-button variant="outline-brand" label="Agregar Producto" onclick={aceptar}></lightning-button>
                </div>
            </div>

            <div class="slds-align_absolute-center">
                <lightning-button variant="brand" label="Cerrar" onclick={cerrar}></lightning-button>
            </div>
    
        </div>
        
    </lightning-modal-body>

</template>