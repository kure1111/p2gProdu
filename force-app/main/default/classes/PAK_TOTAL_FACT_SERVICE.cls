global class PAK_TOTAL_FACT_SERVICE {
	webservice static list<status> FACT(PAK_Update_ACC.TOTAL_FACT[] lsEntity){
        list<status> result = new list<status>();
        Response__c RES = new Response__c();
        try{           
            for(PAK_Update_ACC.TOTAL_FACT TF: lsEntity){
                if(TF.TIPO == 'PEDIDO'){
                    list<Invoice__c> INV= [Select Id,Name,Total_Invoice_SAP__c,Timbrado_Factura_SAP__c,Date_Invoice_SAP__c,Invoice_Status__c From Invoice__c where Id=:TF.IdInovice];
                    list<Shipment_Disbursement__c> DIS= [Select Id,Name,Etapa__c,Total_Invoice_SAP__c,Total_Excl_VAT__c,Timbrado_Factura_SAP__c,Date_Invoice_SAP__c,Disbursement_Status__c From Shipment_Disbursement__c where Id=:TF.IdInovice];
                    if(!INV.isEmpty()){
                        for(Invoice__c I: INV){
                            RES.Invoice__c = I.Id;
                            RES.Object__c='Invoice';
                            //if(TF.TotalFacturado != null && TF.TotalFacturado != ''){I.Total_Invoice_SAP__c = Decimal.valueOf(TF.TotalFacturado);}
                            if(TF.UI != null && TF.UI != ''){I.Timbrado_Factura_SAP__c = TF.UI;}
                            if(TF.FechaFactura != null && TF.FechaFactura != ''){I.Date_Invoice_SAP__c = Date.valueOf(TF.FechaFactura);}
                            RES.Message__c = 'Creada Factura:'+TF.UI+', Monto Facturado: '+TF.TotalFacturado + ', Invoice Status BU: ' + I.Invoice_Status__c;
                            I.Invoice_Status__c = 'Facturado';
                            I.Facturado_2__c =  Datetime.now();
                            update I;
                            RES.Message__c += ', Invoice Status AU: ' + I.Invoice_Status__c;
                        }    
                    }else if(!DIS.isEmpty()){
                        for(Shipment_Disbursement__c I: DIS){
                            RES.Disbursement__c = I.Id;
                            RES.Object__c='Disbursement';
                            if(TF.TotalFacturado != null && TF.TotalFacturado != ''){if(I.Total_Invoice_SAP__c == null){I.Total_Invoice_SAP__c = 0;}I.Total_Invoice_SAP__c = I.Total_Invoice_SAP__c + Decimal.valueOf(TF.TotalFacturado);}
                            if(TF.UI != null && TF.UI != ''){I.Timbrado_Factura_SAP__c = TF.UI;}
                            if(TF.FechaFactura != null && TF.FechaFactura != ''){I.Date_Invoice_SAP__c = Date.valueOf(TF.FechaFactura);}
                            RES.Message__c = 'Creada Factura: '+TF.UI+', Monto Facturado: '+TF.TotalFacturado;
                            I.Disbursement_Status__c = 'Facturado';
                            if(I.Total_Excl_VAT__c > I.Total_Invoice_SAP__c){I.Etapa__c = 'Parcialidad';}else{I.Etapa__c = 'Pagado';}
                            update I;
                        }    
                    }
                }else if(TF.TIPO == 'NOTA'){
                    
                }               
                status st = new status();
                st.code = '1';
                st.message = 'Exitoso- el registro fue actualizado';
                st.registry = TF;
                result.add(st);
                RES.Type__c = 'CONFIRM';
				insert RES;                
                System.debug('----------'+result);  
            }
            
        	return result;   
        }catch(Exception e){
            RES.Type__c = 'ERROR';
            RES.Message__c = e.getCause()+' '+e.getMessage();
            //insert RES;
            System.debug(e.getCause()); System.debug(e.getMessage()); System.debug(e.getLineNumber());
			status st = new status(); st.code = '0'; st.message = 'Existe un error en el web services, por favor revise la trasabilidad de la transacciÃ³n' + e.getCause() +' '+ e.getMessage() +' '+ e.getLineNumber();				
			result.add(st);
			return result;
        }
    }
    global class status {
        webservice String code {get; set;}
        webservice String message {get; set;}
        webservice PAK_Update_ACC.TOTAL_FACT registry {get; set;}
    }
    
    public void TestMetodo(){
        String Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
       	Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
        Test0 = '';
    }
}