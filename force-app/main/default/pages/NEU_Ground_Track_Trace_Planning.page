<apex:page id="page" StandardController="Shipment_Program__c" extensions="NEU_Ground_Track_Trace_Planning" sidebar="false" tabStyle="Shipment_Program__c">
    <apex:includeScript value="{!$Resource.neu_jquery}"/> 
    <apex:includeScript value="{!$Resource.jquery_1_10_2}"/> 
    <apex:includeScript value="{!$Resource.jquery_ui_1_10_3}"/>
    <apex:includeScript value="{!$Resource.neurored_jquery}"/> 
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyAK8UqXuiT9IFTwkvhF-Nh1wS2JAdk6Fig"></script>
    <apex:stylesheet value="{!URLFOR($Resource.jquery_ui_1_10_3_css,'jquery-ui-1.10.3.min.css')}"/>
    <script>
    
        $(document).ready(function () 
        {
            initialize_inicio();
        });
        var showedWindows=[];
        var route_paint_init = false;
        var waypts = [];
        var activities=[];
        var cactivity;
        var activitylocation;
        var map;
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var markers = [];
        var geocoder;
        var optimizar_coordenadas = false;
        var save_latitude = false;
        var save_route = false;
        var marker_not_found = false;
        function initialize_inicio() {
            var mundo= new google.maps.LatLng(49.303305,12.341852); 
            var mapOptions = {
                zoom: 3,
                center: mundo
                };
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
            geocoder = new google.maps.Geocoder();
            if(document.getElementById('{!$Component.form.Optimization_by_Google}').value == 'true')
                optimizar_coordenadas = true;
            else
                optimizar_coordenadas = false;
            showactivities();
        }
        
        function showactivities()
        {
            save_latitude=false;
            activities=document.getElementById('{!$Component.form.direcciones_recogidas}').value.split('|');
            cactivity=(Math.floor(activities.length/9)-1)*9;
            marker_not_found=false;
            preshowactivity();
        }
        
        function preshowactivity()
        {
            if(cactivity>=0)
            {
                activitylocation=activities[cactivity+8].trim();
                if(activitylocation)
                    showactivity();
                else
                {
                    $('.'+activities[cactivity+5].trim()+'_address_'+activities[cactivity+4].trim()).css('color','red');
                    marker_not_found=true;
                    cactivity-=9;
                    setTimeout(function(){preshowactivity();},200);
                }
            }
            else
            {
                if(marker_not_found)
                {
                  alert('Route not found, addresses marked in red not found');
                  return;
                }
                pintar_ruta();
            }
        }
        
        function showactivity()
        {
            var lat=parseFloat(activities[cactivity+6].trim());
            var lot=parseFloat(activities[cactivity+7].trim());
            if(isNaN(lat)||isNaN(lot))
            {
                geocoder.geocode( { 'address': activitylocation}, function(results, status) {
                  if (status == google.maps.GeocoderStatus.OK) 
                  {
                    save_latitude=true;
                     map.setCenter(results[0].geometry.location);
                     var marker = new google.maps.Marker({
                         map: map,
                         position: results[0].geometry.location,
                         location: activitylocation,
                         id_pedido: activities[cactivity+4].trim(),
                         direccion_entrega: activities[cactivity+7].trim(),
                         tipo_origin_destination: activities[cactivity+5].trim(),
                         direcion_letra: activities[cactivity+8].trim(),
                         animation: google.maps.Animation.DROP,
                         icon:'https://maps.google.com/mapfiles/'+activities[cactivity+3].trim()+'.png'
                    });
                    $('.coordenadas_lat_'+activities[cactivity+5].trim()+'_'+activities[cactivity+4].trim()).val(results[0].geometry.location.lat());
                    $('.coordenadas_log_'+activities[cactivity+5].trim()+'_'+activities[cactivity+4].trim()).val(results[0].geometry.location.lng());
                     markers.push(marker);
                     
                     var infowindow = new google.maps.InfoWindow({
                       content:'<div style="color: black;">'+ activities[cactivity+1].trim()+'<br/>'+activities[cactivity].trim()+'<br/>'+activities[cactivity+2].trim()+'</div>'
                       });
                       
                     google.maps.event.addListener(marker, 'click', function() {
                       infowindow.open(marker.get('map'), marker);
                       showedWindows.push(infowindow);
                       });
                       
                    cactivity-=9;
                    setTimeout(function (){preshowactivity();}, 200);
                  }
                  else if(status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT)
                    setTimeout(function(){showactivity();},2000);
                  else if(status == google.maps.GeocoderStatus.ZERO_RESULTS)
                  {
                        var pos=activitylocation.indexOf(' ');
                        if(pos>=0)
                        {
                            activitylocation=activitylocation.substring(pos+1);
                            setTimeout(function (){showactivity();},0);
                        }
                        else
                        {
                            $('.'+activities[cactivity+5].trim()+'_address_'+activities[cactivity+4].trim()).css('color','red');
                            marker_not_found=true;
                            cactivity-=9;
                            setTimeout(function(){preshowactivity();},200);
                        }
                   }
                 });
             }
             else
             {  
                 var position_marks = new google.maps.LatLng(lat,lot); 
                 var marker = new google.maps.Marker({
                 map: map,
                 position: position_marks,
                 location: activities[cactivity+8].trim(),
                 id_pedido: activities[cactivity+4].trim(),
                 direccion_entrega: activities[cactivity+7].trim(),
                 tipo_origin_destination: activities[cactivity+5].trim(),
                 direcion_letra: activities[cactivity+8].trim(),
                 animation: google.maps.Animation.DROP,
                 icon:   activities[cactivity+3].indexOf("Flag_finish") > -1 || activities[cactivity+3].trim().length > 20 ? activities[cactivity+3].trim() : 'https://maps.google.com/mapfiles/'+activities[cactivity+3].trim()+'.png'
                 });

                 markers.push(marker);

                 var infowindow = new google.maps.InfoWindow({
                 content:'<div style="color: black;">'+ activities[cactivity+1].trim()+'<br/>'+activities[cactivity].trim()+'<br/>'+activities[cactivity+2].trim()+'</div>'
                 });
                  
                 google.maps.event.addListener(marker, 'click', function() {
                 infowindow.open(marker.get('map'), marker);
                 showedWindows.push(infowindow);
                 });
                  
                 cactivity-=9;
                 preshowactivity();
             }
        }
        
        function pintar_ruta()
        {
            if(markers.length<2)
            {
                alert('No route to show');
                return;
            }
            var start=markers[markers.length-1].position;
            var end=markers[0].position;
            if(route_paint_init == false)
            {
                directionsDisplay = new google.maps.DirectionsRenderer();
            }
            else
            {
                directionsDisplay.setMap(null);    
                directionsService = new google.maps.DirectionsService();
                waypts = [];
            }
            var markers2 = [];
            for(var i=markers.length-2;i>0;i--)
            {
                waypts.push({location:markers[i].position,stopover:true});
                markers2.push(markers[i]);
            }

            var request;
            if(optimizar_coordenadas == true) 
            {
                request = {
                    origin: start,
                    destination: end,
                    waypoints: waypts,
                    optimizeWaypoints: true,
                    travelMode: google.maps.TravelMode.DRIVING
                };
            }
            else
            {
                request = {
                    origin: start,
                    destination: end,
                    waypoints: waypts,
                    provideRouteAlternatives: false,
                    //optimizeWaypoints: true,
                    travelMode: google.maps.TravelMode.DRIVING
                };
            }
              
            var pointsArray = [];
            var example = [];
                                    
            //esto es para pintar la route
           directionsDisplay.setMap(map);
           directionsDisplay.setOptions( { suppressMarkers: true } );
            directionsService.route(request, function(response, status) {
              if (status == google.maps.DirectionsStatus.OK) 
              {
                 directionsDisplay.setDirections(response);
                 if((optimizar_coordenadas == true)||(save_route))
                 {
                    optimizar_coordenadas=false;
                    save_route=false;
                     var route = response.routes[0];
                     var array_position_waypoints = route.waypoint_order;
                     var contador_markers_origin = 1;
                     var contador_markers_destination = 0;
                     for (var i = 0; i < array_position_waypoints.length; i++) 
                     {
                        var shipment_recolocado = markers2[array_position_waypoints[i]].id_pedido;
                        var shipment_origin_destination = markers2[array_position_waypoints[i]].tipo_origin_destination;
                        
                        if(shipment_origin_destination=='origin')
                            $('.position_'+shipment_origin_destination+'_'+shipment_recolocado).val(contador_markers_origin++);
                        else if(shipment_origin_destination=='destination')
                            $('.position_'+shipment_origin_destination+'_'+shipment_recolocado).val(contador_markers_destination++);
                     }
                 
                    $('.kms_origin,.duration_origin,.kms_destination,.duration_destination'+shipment_recolocado).html('');  
                    $('.kms_origin2,.duration_origin2,.kms_destination2,.duration_destination2'+shipment_recolocado).val('');
                    var total_kms=0;
                      for (var i = 0; i < route.legs.length-1; i++) 
                      {
                        var kms=route.legs[i].distance.value;
                        total_kms+=kms;
                        var duration=route.legs[i].duration.value;
                        if(markers2[array_position_waypoints[i]] != null)
                        {
                            var shipment_recolocado =  markers2[array_position_waypoints[i]].id_pedido;
                            var shipment_origin_destination = markers2[array_position_waypoints[i]].tipo_origin_destination;
                            if((shipment_origin_destination=='origin')||(shipment_origin_destination=='destination'))
                            {
                                kms+=$('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).getFloat();
                                duration+=$('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).getFloat();
                                var d=(kms/1000).toFixed(0)+' kms';
                                if(d!='0 kms')
                                {
                                    $('.kms_'+shipment_origin_destination+'.'+shipment_recolocado).html(d); 
                                    $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val(d); 
                                }
                                else
                                {
                                    $('.kms_'+shipment_origin_destination+'.'+shipment_recolocado).html('');    
                                    $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val('');    
                                }
                                var d=(duration/3600).toFixed(2)+' h';
                                if(d!='0.00 h')
                                {
                                    $('.duration_'+shipment_origin_destination+'.'+shipment_recolocado).html(d);    
                                    $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val(d);    
                                }
                                else
                                {
                                    $('.duration_'+shipment_origin_destination+'.'+shipment_recolocado).html('');   
                                    $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val('');   
                                }
                            }
                            else
                            {
                                for(var j=0;j<array_position_waypoints.length;j++)
                                    if(array_position_waypoints[j]==array_position_waypoints[i]+1)
                                    {
                                        shipment_recolocado = markers2[array_position_waypoints[j]].id_pedido;
                                        shipment_origin_destination = markers2[array_position_waypoints[j]].tipo_origin_destination;
                                        $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val(kms);
                                        $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val(duration);
                                        break;
                                    }
                                if(j==array_position_waypoints.length)
                                {
                                    shipment_recolocado = markers[0].id_pedido;
                                    shipment_origin_destination = markers[0].tipo_origin_destination;
                                    $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val(kms);
                                    $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val(duration);
                                    break;
                                }
                            }
                        }
                      }
                    var shipment_recolocado =  markers[0].id_pedido;
                    var shipment_origin_destination = markers[0].tipo_origin_destination;
                    if((shipment_origin_destination=='origin')||(shipment_origin_destination=='destination'))
                    {
                        var kms=route.legs[route.legs.length-1].distance.value;
                        total_kms+=kms;
                        var duration=route.legs[route.legs.length-1].duration.value;
                        kms+=$('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).getFloat();
                        duration+=$('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).getFloat();
                        var d=(kms/1000).toFixed(0)+' kms';
                        if(d!='0 kms')
                        {
                            $('.kms_'+shipment_origin_destination+'.'+shipment_recolocado).html(d); 
                            $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val(d); 
                        }
                        else
                        {
                            $('.kms_'+shipment_origin_destination+'.'+shipment_recolocado).html('');    
                            $('.kms_'+shipment_origin_destination+'2.'+shipment_recolocado).val('');    
                        }
                        var d=(duration/3600).toFixed(2)+' h';
                        if(d!='0.00 h')
                        {
                            $('.duration_'+shipment_origin_destination+'.'+shipment_recolocado).html(d);    
                            $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val(d);    
                        }
                        else
                        {
                            $('.duration_'+shipment_origin_destination+'.'+shipment_recolocado).html('');   
                            $('.duration_'+shipment_origin_destination+'2.'+shipment_recolocado).val('');   
                        }
                    }
                    var d=(total_kms/1000).toFixed(0);
                    if(d!='0')
                        $('#page\\:form\\:Total_Distance_kms').val(d);  
                    else
                        $('#page\\:form\\:Total_Distance_kms').val(''); 
                     save_coordenadas();  
                  }
                  else if(save_latitude)
                    save_coordenadas(); 
              }
              else if(status == google.maps.DirectionsStatus.NOT_FOUND)
              {
                    alert('Route not found');
                  if(optimizar_coordenadas == true)
                  {
                    optimizar_coordenadas = false;
                    pintar_ruta();
                  }
              }
              else if(status == google.maps.DirectionsStatus.MAX_WAYPOINTS_EXCEEDED)
              {
                optimizar_coordenadas = false;
                alert('Max waypoints exceeded');
              }
              else
              {
                alert('Route not found');
                  if(optimizar_coordenadas == true)
                  {
                    optimizar_coordenadas = false;
                    pintar_ruta();
                  }
              }
            }); 
        }
        
        function send_request_routific()
        {
            var objXMLHttp=null
            if(window.XMLHttpRequest)
            {
                objXMLHttp = new XMLHttpRequest()
            }
            else if (window.ActiveXObject)
            {
                objXMLHttp = new ActiveXObject("Microsoft.XMLHttp")
            }

            var url_post ='https://api.routific.com/v1/pdp';
            //key buena
            //var key = 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI1OTk0NjNiM2Y2OTkzZWQxMTY5YTFlNjEiLCJpYXQiOjE1MDI4OTcwNzV9.z3yxvX9oIrmkQqsyYSm5nVuIdLSeHOMibFEDx0NqxYc';
            //key test
            var key = 'bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJfaWQiOiI1MzEzZDZiYTNiMDBkMzA4MDA2ZTliOGEiLCJpYXQiOjEzOTM4MDkwODJ9.PR5qTHsqPogeIIe0NyH2oheaGR-SJXDsxPTcUQNq90E';
            
            var xhr = objXMLHttp;
            xhr.upload.addEventListener("progress", uploadProgress, false);
            xhr.addEventListener("load", uploadComplete, false);
            xhr.open('POST', url_post , true);
            xhr.setRequestHeader('Content-Type', 'application/json')
            xhr.setRequestHeader("Authorization",key );
            
            var body_request = '';
            var contador_marcas = 0;
            /*recoger datos*/
            if(markers.length>0) // debe tener minimo 2 para que funcione
            {
                var contenedor_shipments = '';
                body_request +='{';
                body_request +='    "visits": {';
                for(var i=0 ;i < markers.length;i++)//recorrer todas las marcas
                {
                    if(contenedor_shipments == '' || contenedor_shipments.indexOf(markers[i].id_pedido) == -1)
                    {
                        body_request +='        "Shipment '+markers[i].id_pedido+'": {';//puedo poner el id que necestite
                       // body_request +='            "load": '+{!Shipment_Program__c.Total_Gross_Weight_Kg__c} +',';// poner el peso de cada shipment( no del shipments program)
                        body_request +='            "load": '+$('.shipment_weight_'+markers[i].id_pedido+'').val() +',';
                        for(var z=0 ;z < markers.length;z++)//hay que buscar y juntar las de origen y las de destino
                        {
                            if(markers[i].id_pedido == markers[z].id_pedido)
                            {
                                if(markers[z].tipo_origin_destination == 'origin')
                                {
                                    body_request +='            "pickup": {';
                                    body_request +='                "location": {';
                                    //body_request +='                    "name": "import-export 11",';//puedo poner lo que sea
                                    //body_request +='                    "lat": 49.2474624,';
                                    //body_request +='                    "lng": -123.1532338';
                                    body_request +='                    "name": "'+markers[z].direcion_letra+'",';//puedo poner lo que sea
                                    body_request +='                    "lat": "'+$('.coordenadas_lat_'+markers[z].tipo_origin_destination+'_'+markers[z].id_pedido+'').val()+'",';
                                    body_request +='                    "lng": "'+$('.coordenadas_log_'+markers[z].tipo_origin_destination+'_'+markers[z].id_pedido+'').val()+'"';
                                    body_request +='                },';
                                    body_request +='                "start": "9:00",';
                                    body_request +='                "end": "12:00",';
                                    body_request +='                "duration": 10';
                                    body_request +='            },';
                                    contador_marcas ++;
                                }
                            }
                        }
                        
                        for(var z=0 ;z < markers.length;z++)//hay que buscar y juntar las de origen y las de destino
                        {
                            if(markers[i].id_pedido == markers[z].id_pedido)
                            {
                                if(markers[z].tipo_origin_destination == 'destination')
                                {
                                    body_request +='            "dropoff": {';
                                    body_request +='                "location": {';
                                    //body_request +='                    "name": "Import-Export 11",';
                                    //body_request +='                    "lat": 49.227107,';
                                    //body_request +='                    "lng": -123.1163085';
                                    body_request +='                    "name": "'+markers[z].direcion_letra+'",';//puedo poner lo que sea
                                    body_request +='                    "lat": "'+$('.coordenadas_lat_'+markers[z].tipo_origin_destination+'_'+markers[z].id_pedido+'').val()+'",';
                                    body_request +='                    "lng": "'+$('.coordenadas_log_'+markers[z].tipo_origin_destination+'_'+markers[z].id_pedido+'').val()+'"';
                                    body_request +='                },';
                                    body_request +='                "start": "9:00",';
                                    body_request +='                "end": "12:00",';
                                    body_request +='                "duration": 10';
                                    body_request +='            }';
                                    contador_marcas ++;
                                    break;
                                }
                            }
                        }    

                        if(contador_marcas  == markers.length)
                            body_request +='            }';// si es el ultimo envio no poner coma
                        else
                            body_request +='            },';
                        
                        contenedor_shipments += markers[i].id_pedido+',';
                    }
                }
                body_request +='        },';
                
                /* se puede hacer aqui para recorrer si hay mas camiones*/
                body_request +='    "fleet": {';
                //body_request +='        "vehicle_1": {';//puedo poner lo que sea
                body_request +='        "vehicle_1 furgo inveco": {';//puedo poner lo que sea
                body_request +='            "start_location": {';
                body_request +='                "id": "depot",';
                body_request +='                "name": "800 Kingsway",';
                body_request +='                "lat": 49.2553636,';
                body_request +='                "lng": -123.0873365';
                body_request +='            },';
                body_request +='            "end_location": {';
                body_request +='                "id": "depot",';
                body_request +='                "name": "800 Kingsway",';
                body_request +='                "lat": 49.2553636,';
                body_request +='                "lng": -123.0873365';
                body_request +='            },';
               // body_request +='            "shift_start": "8:00",';
               // body_request +='            "shift_end": "12:00",';
                body_request +='               "capacity": 2';
                body_request +='        }';//,
                
                body_request +='    }';
                body_request +='}';
                //body_request +='    }';
            }
            alert(body_request);
            console.log(body_request);
            /*Envio de datos*/ 
           // xhr.send(body_request);  
        }
        
        function uploadProgress(evt) 
        {
            if (evt.lengthComputable) 
            {
              var percentComplete = Math.round(evt.loaded * 100 / evt.total);
              /*-----------------------*/
              
            }
            else 
            {
                /*----------else----------*/
            }
        }
        
        function uploadComplete(evt) 
        {
            alert(evt.target.response);
            /* This event is raised when the server send back a response */
          
        }
        
        function vaciar_addicional_location()
        {
            optimizar_coordenadas=true;
            save_changes_shipments(true);
        }
        
        function repintar_route_and_marquers(force_save_route)
        {
            if(force_save_route)
                save_route=true;
            else
                save_route=false;
            route_paint_init = false;
            waypts = [];
            activities=[];
            directionsService = new google.maps.DirectionsService();
            for(var i=0;i<markers.length;i++)
                markers[i].setMap(null);
            markers=[];
            showedWindows=[];
            directionsDisplay.setMap(null);
            showactivities();
        }
        
        function animar_marca(selected)
        {
            for(var i=0;i<showedWindows.length;i++)
                showedWindows[i].close();
            showedWindows=[];
              for (var i = 0; i < markers.length; i++)
                   if((selected == markers[i].id_pedido)||(selected+'1' == markers[i].id_pedido))
                       activa_animacion(markers[i]); 
        }
        
        function activa_animacion(marca)
        {
            google.maps.event.trigger(marca,'click');
            marca.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(function (){marca.setAnimation(null);},3000);
        }
        function copyOriginAddress(id)
        {
            $('textarea.origin_address_'+id).val($('span.initial_origin_address_'+id).text());
            emptyCoor(id,'origin');
        }
        function copyDestinationAddress(id)
        {
            $('textarea.destination_address_'+id).val($('span.final_destination_address_'+id).text());
            emptyCoor(id,'destination');
        }
        function emptyCoor(shipid,coorType)
        {
            $('.coordenadas_lat_'+coorType+'_'+shipid+',.coordenadas_log_'+coorType+'_'+shipid).val('');
        }
    </script>
    <style>
        .div_position{
                width: 22px;
                float: left;
                margin-top: 11px;
                text-align: center;
        }
        .div_up{    
                width: 20px;
                height: 18px;
                background-image: url(/img/alohaSkin/fewer_more.png);
                background-repeat: no-repeat;
                background-size: 18px;
                background-position-y: -14px;
                background-position-x: 0px;
                cursor: pointer;
             }
        .div_down{    
                width: 20px;
                height: 18px;
                background-image: url(/img/alohaSkin/fewer_more.png);
                background-repeat: no-repeat;
                background-size: 18px;
                background-position-y: 3px;
                background-position-x: 0px;
                cursor: pointer;
             }
    </style>
    <apex:form id="form">
        <div class="waitingSearchDiv" id="otherStatus" style="display:none;background-color:#fbfbfb;height:100%;opacity:0.65;width:100%;"> 
             <div class="waitingHolder" style="top:74.2px;width:91px;">
                 <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                 <span class="waitingDescription">Loading...</span>
             </div>
         </div>
        <apex:outputLink value="{!URLFOR($Action.Shipment_Program__c.View,mysp.id)}" rendered="{!mysp!=null}">
           <apex:sectionHeader title="Road Route Planning" subtitle="{!mysp.Name}"></apex:sectionHeader>
        </apex:outputLink>
        <apex:pageMessages id="pagemessages"/>
        <!-- <apex:inputhidden value="{!id_shipment_pos}" html-class="id_shipments"/>-->
        <apex:inputhidden value="{!Optimization_by_Google}" id="Optimization_by_Google" html-class="Optimization_by_Google"/>
        
        <apex:actionFunction name="save_coordenadas" reRender="shipments_origins,shipments_destinations,pagemessages" status="myStatus" action="{!save_coordenadas}"/>
        <apex:actionFunction name="reorder_load_up" reRender="shipments_origins,direcciones_recogidas,pagemessages" action="{!reorder_load_up}" status="myStatus" oncomplete="repintar_route_and_marquers(true);">
            <apex:param name="firstParam" assignTo="{!id_shipment_pos}" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="reorder_load_down" reRender="shipments_origins,direcciones_recogidas, pagemessages" action="{!reorder_load_down}" status="myStatus" oncomplete="repintar_route_and_marquers(true);"> 
            <apex:param name="firstParam" assignTo="{!id_shipment_pos}" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="reorder_discharge_up" reRender="shipments_destinations,direcciones_recogidas, pagemessages" action="{!reorder_discharge_up}" status="myStatus" oncomplete="repintar_route_and_marquers(true);">
            <apex:param name="firstParam" assignTo="{!id_shipment_pos}" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="reorder_discharge_down" reRender="shipments_destinations,direcciones_recogidas, pagemessages" action="{!reorder_discharge_down}" status="myStatus" oncomplete="repintar_route_and_marquers(true);">
            <apex:param name="firstParam" assignTo="{!id_shipment_pos}" value="" />
        </apex:actionFunction>
        <apex:actionFunction name="save_changes_shipments" action="{!save_changes_shipments}" reRender="shipments_origins,shipments_destinations,direcciones_recogidas, pagemessages" status="myStatus" oncomplete="repintar_route_and_marquers(true);">
            <apex:param name="firstParam" assignTo="{!emptyAditionals}" value="" />
        </apex:actionFunction>
        <apex:inputHidden value="{!direcciones_recogidas}" id="direcciones_recogidas" />
        <apex:inputHidden value="{!Shipment_Program__c.Total_Distance_kms__c}" id="Total_Distance_kms" />
        <div id="map_canvas" style="width:100%; height: 400px;"></div>
        <div style="    width: 100%;    text-align: center;    margin: 5px;">
            <input type="button" class="btn" value="Optimization by Google" onclick="vaciar_addicional_location();"/>
            <input type="button" class="btn" value="Optimization by Routific" /><!--onclick="send_request_routific();"-->
        </div>
        <apex:pageBlock title="Shipments Loads" id="shipments_origins">
            <apex:pageBlockButtons >
                <apex:commandButton value="Save Data" status="myStatus" reRender="direcciones_recogidas" action="{!save_changes_shipments}" oncomplete="repintar_route_and_marquers(true);"/>
            </apex:pageBlockButtons>
            <apex:pageBlockTable id="table" value="{!list_shipment_related_load}" var="ship">
                 
                <apex:column id="posicion_shipment_origin" style="    min-width: 65px;">
                     <apex:facet name="header">
                         Position
                     </apex:facet>
                     <div class="div_position">
                         <div class="div_up div_up_{!ship.shipments.Id}" style="display:{!If(ship.position == null || ship.position == 0, 'none' ,'')}" onclick="reorder_load_up('{!ship.shipments.Id}');"></div>
                         <div class="div_down div_down_{!ship.shipments.Id}" style="display:{!If(ship.position == null || ship.position == maximun_shipments-1, 'none' ,'')}" onclick="reorder_load_down('{!ship.shipments.Id}');"></div>
                     </div>
                     <img src="{!ship.link_icon}" class="{!ship.shipments.Id}" onclick="animar_marca('{!ship.shipments.Id}');" style="cursor: pointer;margin-left:6px;"/>
                     <apex:inputHidden value="{!ship.position}" html-class="position_origin_{!ship.shipments.Id}"/>
                     <apex:inputHidden value="{!ship.shipments.Total_Weight_Kg__c}" html-class="shipment_weight_{!ship.shipments.Id}"/>
                 </apex:column>
                 
                 <apex:column headerValue="{!$ObjectType.Shipment__c.fields.Name.Label}">
                    <c:customobject2 objid="{!ship.shipments.id}" objname="{!ship.shipments.Name}"/>
                 </apex:column>
                 
                 <apex:column headerValue="{!$ObjectType.Customer_Quote__c.Label}">
                    <c:customobject2 objid="{!ship.ie.id}" objname="{!ship.ie.Name}"/>
                 </apex:column>
                 
                 <apex:column value="{!ship.shipments.Site_of_Load__c}"/>
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Origin_Address__c.Label}
                     </apex:facet>
                     <apex:outputText value="{!ship.shipments.Origin_Address__c}" styleclass="initial_origin_address_{!ship.shipments.id}"/>
                    <img src="/img/func_icons/cal/rightArrow.gif" onclick="copyOriginAddress('{!ship.shipments.id}');" style="cursor:pointer;float:right"/>
                 </apex:column>

                 <apex:column headerValue="{!$ObjectType.Shipment__c.fields.Origin_Address_Shipment__c.Label}">
                     <apex:inputField value="{!ship.shipments.Origin_Address_Shipment__c}" styleclass="origin_address_{!ship.shipments.id}" onchange="emptyCoor('{!ship.shipments.id}','origin');"/>
                 </apex:column>
                 
                  <apex:column id="kms_origin">
                     <apex:facet name="header">
                         kms
                     </apex:facet>
                    <apex:outputText value="{!ship.shipments.Kms_Origin__c}" html-class="kms_origin {!ship.shipments.id}"/>
                    <apex:inputhidden value="{!ship.shipments.Kms_Origin__c}" html-class="kms_origin2 {!ship.shipments.id}"/>
                 </apex:column>

                  <apex:column id="duration_origin">
                     <apex:facet name="header">
                        Google Time
                     </apex:facet>
                    <apex:outputText value="{!ship.shipments.Google_Time__c}" html-class="duration_origin {!ship.shipments.id}"/>
                    <apex:inputhidden value="{!ship.shipments.Google_Time__c}" html-class="duration_origin2 {!ship.shipments.id}"/>
                 </apex:column>

                  <apex:column id="transit_time_origin2">
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Total_Transit_Time_Hours__c.Label}
                     </apex:facet>
                    <apex:outputText value="{!ship.Transit_time}"/>
                 </apex:column>
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Equip_Placed__c.Label}
                     </apex:facet>
                     <apex:inputField value="{!ship.shipments.Equip_Placed__c}" html-class="equip_placed_origin_{!ship.shipments.id}"/>
                 </apex:column>
                      
                  <apex:column id="transit_time_origin">
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Loading_Time_Hours__c.Label}
                     </apex:facet>
                     <apex:outputText value="{!ship.Loading_Time}"/>
                 </apex:column>
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.ETD_from_Point_of_Load__c.Label}
                     </apex:facet>
                     <apex:inputField value="{!ship.shipments.ETD_from_Point_of_Load__c}" html-class="etd_origin_{!ship.shipments.id}"/>
                     <apex:inputhidden value="{!ship.shipments.Origin_Address_Latitude__c}" html-class="coordenadas_lat_origin_{!ship.shipments.id}"/>
                     <apex:inputhidden value="{!ship.shipments.Origin_Address_Longitude__c}" html-class="coordenadas_log_origin_{!ship.shipments.id}"/>
                     <apex:inputhidden value="{!ship.shipments.Additional_Location_Latitude__c}" html-class="coordenadas_lat_origint_{!ship.shipments.id}1 aditionals"/>
                     <apex:inputhidden value="{!ship.shipments.Additional_Location_Longitude__c}" html-class="coordenadas_log_origint_{!ship.shipments.id}1 aditionals"/>
                 </apex:column>
                 
                 <apex:column >
                     <apex:facet name="header">
                         Route Through
                     </apex:facet>
                    <apex:inputField value="{!ship.shipments.Additional_Location__c}" styleclass="origin_address_{!ship.shipments.id}1 aditionals" onchange="emptyCoor('{!ship.shipments.id}1','origint');"/>
                 </apex:column>
                 
            </apex:pageBlockTable>
        </apex:pageBlock>
        
        
        <apex:pageBlock title="Shipments Discharges" id="shipments_destinations">
            <apex:pageBlockButtons >
                <apex:commandButton value="Save Data" status="myStatus" reRender="direcciones_recogidas" action="{!save_changes_shipments}" oncomplete="repintar_route_and_marquers(true);"/>
            </apex:pageBlockButtons>
            <apex:pageBlockTable id="table" value="{!list_shipment_related_discharge}" var="ship">
            
                 <apex:column style="    min-width: 65px;" id="posicion_shipment_destinations" >
                     <apex:facet name="header">
                         Position
                     </apex:facet>
                      <div class="div_position">
                         <div class="div_up"  style="display:{!If(ship.position == null || ship.position == 0, 'none' ,'')}" onclick="reorder_discharge_up('{!ship.shipments.Id}');"></div>
                         <div class="div_down" style="display:{!If(ship.position == null || ship.position == maximun_shipments-1, 'none' ,'')}" onclick="reorder_discharge_down('{!ship.shipments.Id}');"></div>
                     </div>
                     <img src="{!ship.link_icon}" style="    margin-left: 6px; cursor: pointer;" onclick="animar_marca('{!ship.shipments.Id}');"/>
                     <apex:inputHidden value="{!ship.position}" html-class="position_destination_{!ship.shipments.Id}"/>
                 </apex:column>
                 
                 <apex:column headerValue="{!$ObjectType.Shipment__c.fields.Name.Label}">
                    <c:customobject2 objid="{!ship.shipments.id}" objname="{!ship.shipments.Name}"/>
                 </apex:column>
                 
                 <apex:column headerValue="{!$ObjectType.Customer_Quote__c.Label}">
                    <c:customobject2 objid="{!ship.ie.id}" objname="{!ship.ie.Name}"/>
                 </apex:column>
                 
                 <apex:column value="{!ship.shipments.Site_of_Discharge__c}"/>
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Destination_Address__c.Label}  
                     </apex:facet>
                     <apex:outputText value="{!ship.shipments.Destination_Address__c}" styleclass="final_destination_address_{!ship.shipments.id}"/>
                    <img src="/img/func_icons/cal/rightArrow.gif" onclick="copyDestinationAddress('{!ship.shipments.id}');" style="cursor:pointer"/>
                 </apex:column>

                 <apex:column headerValue="{!$ObjectType.Shipment__c.fields.Delivery_Address_Shipment__c.Label}">
                     <apex:inputField value="{!ship.shipments.Delivery_Address_Shipment__c}" styleclass="destination_address_{!ship.shipments.id}" onchange="emptyCoor('{!ship.shipments.id}','destination');"/>
                 </apex:column>
                  
                 <apex:column id="kms_destination">
                     <apex:facet name="header">
                         kms
                     </apex:facet>
                    <apex:outputText value="{!ship.shipments.Kms_Destination__c}"  html-class="kms_destination {!ship.shipments.id}"/>
                    <apex:inputhidden value="{!ship.shipments.Kms_Destination__c}"  html-class="kms_destination2 {!ship.shipments.id}"/>
                 </apex:column>

                  <apex:column id="duration_destination">
                     <apex:facet name="header">
                        Google Time
                     </apex:facet>
                    <apex:outputText value="{!ship.shipments.Google_Time_Delivery__c}" html-class="duration_destination {!ship.shipments.id}"/>
                    <apex:inputhidden value="{!ship.shipments.Google_Time_Delivery__c}" html-class="duration_destination2 {!ship.shipments.id}"/>
                 </apex:column>

                 <apex:column id="transit_time_destination" >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Total_Transit_Time_Hours__c.Label}
                     </apex:facet>
                     <apex:outputText value="{!ship.Transit_time_discharge}"/>
                 </apex:column>
                 
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.ETA_Point_of_Discharge__c.Label}
                     </apex:facet>
                     <apex:inputField value="{!ship.shipments.ETA_Point_of_Discharge__c}"/>
                 </apex:column>
                 
                  <apex:column id="unloading_time_destination">
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Unloading_Time_Hours__c.Label}
                     </apex:facet>
                     <apex:outputText value="{!ship.Unloading_Time}"/>
                     <apex:inputhidden value="{!ship.shipments.Final_Delivery_Address_Latitude__c}" html-class="coordenadas_lat_destination_{!ship.shipments.id}"/>
                     <apex:inputhidden value="{!ship.shipments.Final_Delivery_Address_Longitude__c}" html-class="coordenadas_log_destination_{!ship.shipments.id}"/>
                     <apex:inputhidden value="{!ship.shipments.Additional_Location_Destination_Latitude__c}" html-class="coordenadas_lat_destinationt_{!ship.shipments.id}1 aditionals"/>
                     <apex:inputhidden value="{!ship.shipments.Additional_Location_Destination_Longitud__c}" html-class="coordenadas_log_destinationt_{!ship.shipments.id}1 aditionals"/>
                 </apex:column>
                 
                 <apex:column >
                     <apex:facet name="header">
                         {!$ObjectType.Shipment__c.fields.Equip_Unloaded__c.Label}
                     </apex:facet>
                     <apex:inputField value="{!ship.shipments.Equip_Unloaded__c}"/>
                 </apex:column>
                            
                  <apex:column >
                     <apex:facet name="header">
                         Route Through
                     </apex:facet>
                    <apex:inputField value="{!ship.shipments.Additional_Location_Destination__c}" style="display:{!If(ship.position == null || ship.position == maximun_shipments-1, 'none' ,'')}"  styleclass="destination_address_{!ship.shipments.id}1 aditionals" onchange="emptyCoor('{!ship.shipments.id}1','destinationt');"/>
                 </apex:column>
                 
            </apex:pageBlockTable>
        </apex:pageBlock>
        
          <apex:outputpanel >
           <apex:actionstatus id="myStatus">
               <apex:facet name="start">
                   <div class="waitingSearchDiv" id="el_loading" style="background-color: #fbfbfb;
                          height: 100%;opacity:0.65;width:100%;"> 
                       <div class="waitingHolder" style="top: 74.2px; width: 91px;">
                           <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />
                           <span class="waitingDescription">Loading...</span>
                       </div>
                   </div>
               </apex:facet>
           </apex:actionstatus>
        </apex:outputpanel>
    </apex:form>
</apex:page>